name: Build and Release

on:
    push:
        tags:
            - "v*"
        branches:
            - main
    workflow_dispatch:

env:
    VERSION: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}

jobs:
    build:
        name: Build ${{ matrix.platform }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macOS
                      os: macos-latest
                      artifact_name: squiggy-macos
                      artifact_path: Squiggy-*.dmg
                    - platform: Linux
                      os: ubuntu-latest
                      artifact_name: squiggy-linux
                      artifact_path: Squiggy-*.tar.gz

        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install uv
              uses: astral-sh/setup-uv@v5

            - name: Install dependencies
              run: uv pip install --system -e ".[dev]"

            - name: Build with PyInstaller
              run: pyinstaller build/squiggy.spec

            - name: Package (macOS)
              if: runner.os == 'macOS'
              run: |
                  brew install create-dmg
                  create-dmg \
                    --volname "Squiggy Installer" \
                    --window-pos 200 120 \
                    --window-size 800 400 \
                    --icon-size 100 \
                    --app-drop-link 600 185 \
                    "Squiggy-${{ env.VERSION }}-macos.dmg" \
                    "dist/Squiggy.app"

            - name: Package (Linux)
              if: runner.os == 'Linux'
              run: tar -czf Squiggy-${{ env.VERSION }}-linux-x64.tar.gz -C dist Squiggy

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}
                  path: ${{ matrix.artifact_path }}

    release:
        needs: [build]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4

            - name: Extract release notes
              run: |
                  # Extract content for current version only (between this version heading and next version heading)
                  sed -n '/^# Squiggy '"${VERSION#v}"'/,/^# Squiggy [0-9]/p' NEWS.md | sed '$d' > release_body.md
                  # If no next version found, just get everything from current version to end
                  if [ ! -s release_body.md ]; then
                      sed -n '/^# Squiggy '"${VERSION#v}"'/,$p' NEWS.md > release_body.md
                  fi

            - name: Create Release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release create ${{ env.VERSION }} \
                    --title "Squiggy ${{ env.VERSION }}" \
                    --notes-file release_body.md \
                    squiggy-macos/Squiggy-*-macos.dmg \
                    squiggy-linux/Squiggy-*-linux-x64.tar.gz

    release-latest:
        needs: [build]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: write
        steps:
            - name: Download macOS artifact
              uses: actions/download-artifact@v4
              with:
                  name: squiggy-macos

            - name: Update latest release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: latest
                  name: Latest Development Build
                  body: |
                      Latest build from the main branch.

                      **Note:** This is a development build and may be unstable.

                      Built from commit: ${{ github.sha }}
                  files: Squiggy-latest-macos.dmg
                  prerelease: true
                  draft: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
