name: Latest Release

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    latest-release:
        name: Create/Update Latest Draft Release
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  cache: true

            - name: Install dependencies
              run: pixi install

            - name: Install npm dependencies
              run: npm ci

            - name: Run tests
              run: pixi run test

            - name: Build extension
              run: pixi run build

            - name: Get package version
              id: package_version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Building version ${VERSION}"

            - name: Get commit info
              id: commit_info
              run: |
                  echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  echo "COMMIT_MSG<<EOF" >> $GITHUB_OUTPUT
                  git log -1 --pretty=%B >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Delete existing latest release if exists
              continue-on-error: true
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release delete latest --yes || true

            - name: Delete existing latest tag if exists
              continue-on-error: true
              run: |
                  git push origin :refs/tags/latest || true

            - name: Create latest tag
              run: |
                  git tag -f latest
                  git push -f origin latest

            - name: Create draft pre-release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  cat > release_notes.md <<EOF
                  ## Latest Development Build

                  **Version:** ${{ steps.package_version.outputs.VERSION }}
                  **Commit:** ${{ steps.commit_info.outputs.SHORT_SHA }}

                  ### Latest Changes

                  ${{ steps.commit_info.outputs.COMMIT_MSG }}

                  ---

                  ⚠️ **This is a development build** - Not for production use

                  This release is automatically generated from the latest commit on the main branch.
                  EOF

                  gh release create latest \
                    --draft \
                    --prerelease \
                    --title "Latest Development Build (v${{ steps.package_version.outputs.VERSION }}-dev)" \
                    --notes-file release_notes.md \
                    *.vsix
