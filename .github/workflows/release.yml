name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    release:
        name: Create Release
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  cache: true

            - name: Install dependencies
              run: pixi install

            - name: Install npm dependencies
              run: npm ci

            - name: Run tests
              run: pixi run test

            - name: Build extension
              run: pixi run build

            - name: Get version from tag
              id: get_version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

                  # Check if this is a pre-release (contains -, alpha, beta, rc)
                  if [[ $VERSION =~ -(alpha|beta|rc|pre) ]] || [[ $VERSION =~ - ]]; then
                    echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
                  else
                    echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create GitHub Release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  PRERELEASE_FLAG=""
                  if [ "${{ steps.get_version.outputs.IS_PRERELEASE }}" = "true" ]; then
                    PRERELEASE_FLAG="--prerelease"
                  fi

                  gh release create ${{ steps.get_version.outputs.VERSION }} \
                    --title "Squiggy ${{ steps.get_version.outputs.VERSION }}" \
                    --generate-notes \
                    $PRERELEASE_FLAG \
                    build/*.vsix

            - name: Publish to Open VSX Registry
              if: success() && startsWith(github.ref, 'refs/tags/v')
              env:
                  OVSX_PAT: ${{ secrets.OVSX_PAT }}
              run: |
                  if [ -z "$OVSX_PAT" ]; then
                    echo "‚ö†Ô∏è  OVSX_PAT not set - skipping Open VSX publish"
                    echo "To publish to Open VSX:"
                    echo "1. Create token at https://open-vsx.org/"
                    echo "2. Add as OVSX_PAT secret in GitHub repository settings"
                    exit 0
                  fi

                  echo "üì¶ Publishing to Open VSX Registry..."
                  npx ovsx publish build/*.vsix -p $OVSX_PAT

                  if [ "${{ steps.get_version.outputs.IS_PRERELEASE }}" = "true" ]; then
                    echo "‚úÖ Pre-release published to Open VSX"
                  else
                    echo "‚úÖ Stable release published to Open VSX"
                  fi

            - name: Publish to VS Code Marketplace
              if: success() && startsWith(github.ref, 'refs/tags/v') && steps.get_version.outputs.IS_PRERELEASE == 'false'
              continue-on-error: true
              run: |
                  echo "Skipping VS Code Marketplace publish (not configured yet)"
                  echo "Note: VS Code Marketplace is only for stable releases"
                  # Uncomment when ready to publish to marketplace:
                  # npx vsce publish -p ${{ secrets.VSCE_PAT }}
