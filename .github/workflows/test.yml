name: Tests

on:
    push:
        branches:
            - main
            - feature/*
    pull_request:
        branches:
            - main
    workflow_dispatch:

jobs:
    test:
        name: Tests (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest]

        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Setup pixi
              uses: prefix-dev/setup-pixi@v0.8.1
              with:
                  pixi-version: latest
                  cache: true

            - name: Install dependencies
              run: pixi install

            - name: Install npm dependencies
              run: npm ci

            - name: Run Python linting
              run: pixi run lint-py

            - name: Run TypeScript linting
              run: pixi run lint-ts

            - name: Run TypeScript formatting check
              run: npm run format:check

            - name: Run Python tests with coverage
              run: pixi run pytest tests/ --cov=squiggy --cov-report=xml --cov-report=term

            - name: Run TypeScript tests
              run: npm test

            - name: Upload Python coverage to Codecov
              if: matrix.os == 'ubuntu-latest'
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage.xml
                  flags: python
                  name: python-coverage
                  fail_ci_if_error: false

            - name: Upload TypeScript coverage to Codecov
              if: matrix.os == 'ubuntu-latest'
              uses: codecov/codecov-action@v5
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: typescript
                  name: typescript-coverage
                  fail_ci_if_error: false
